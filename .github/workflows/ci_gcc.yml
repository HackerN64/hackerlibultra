# CI file for GCC builds

name: Build GCC libultra

# Build on every branch push, tag push, and pull request change:
on: [push, pull_request_target]

jobs:
  build_repo:
    name: Build repo
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        target: [libultra, libultra_d, libultra_rom]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - name: Install package requirements
      run: sudo apt-get install -y clang-tools-19 clang-format-19 clang-tidy-19 gcc-mips-linux-gnu binutils-mips-linux-gnu build-essential python3

    - name: Verify formatting on all files
      run: python3 tools/check_format.py --verbose

    - name: Build ${{ matrix.target }}
      run: make -j $(nproc) TARGET=${{ matrix.target }}

    - name: 'Upload Artifact'
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: 'Changes to Apply'
        path: changes.patch
        retention-days: 5
